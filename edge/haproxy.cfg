# HAProxy configuration for load balancing frontend replicas and proxying /api to backend
# Includes health checks and a stats page for monitoring.

global
    log stdout format raw local0
    maxconn 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s

frontend http_in
    bind *:80

    # ACL: route /api/* to backend API, everything else to frontend pool
    acl is_api path_beg /api/
    use_backend backend_api if is_api
    default_backend frontend_pool

    # Enable built-in stats page for monitoring
    stats enable
    stats uri /haproxy?stats
    stats realm HAProxy\ Statistics
    # Simple basic auth (change in production)
    stats auth admin:adm!n
    stats refresh 5s

backend backend_api
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    server api1 be1.nedr:8081 check inter 2s fall 3 rise 2
    server api2 be2.nedr:8081 check inter 2s fall 3 rise 2
    server api3 be3.nedr:8081 check inter 2s fall 3 rise 2

backend frontend_pool
    balance roundrobin
    option httpchk GET /
    http-check expect status 200
    # Mark servers down upon repeated failures to allow failover
    server fe1 fe1.nedr:8080 check inter 2s fall 3 rise 2
    server fe2 fe2.nedr:8080 check inter 2s fall 3 rise 2
    server fe3 fe3.nedr:8080 check inter 2s fall 3 rise 2

    # Custom error page when no servers are available (503 Service Unavailable)
    errorfile 503 /usr/local/etc/haproxy/errors/fe-down.http
